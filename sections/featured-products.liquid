{% schema %}
{
  "name": "Featured Products",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Select Collection"
    },
    {
      "type": "range",
      "id": "products_limit",
      "label": "Number of Products",
      "min": 2,
      "max": 12,
      "step": 1,
      "default": 4
    },
    {
      "type": "checkbox",
      "id": "show_price",
      "label": "Show Price",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_rating",
      "label": "Show Rating",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_add_to_cart",
      "label": "Show Add to Cart Button",
      "default": true
    }
  ],
  "presets": [
    {
      "name": "Featured Products",
      "category": "Products"
    }
  ]
}
{% endschema %}

{% assign collection_obj = collections | where: 'id', section.settings.collection | first %}

{% if collection_obj %}
  {% assign products = collection_obj.products %}

  {% if sort_option == 'best-selling' %}
    {% assign products = products | sort_by: 'best-selling' %}
  {% elsif sort_option == 'price-ascending' %}
    {% assign products = products | sort_by: 'price' %}
  {% elsif sort_option == 'price-descending' %}
    {% assign products = products | sort_by: 'price' | reverse %}
  {% elsif sort_option == 'title-ascending' %}
    {% assign products = products | sort_by: 'title' %}
  {% elsif sort_option == 'title-descending' %}
    {% assign products = products | sort_by: 'title' | reverse %}
  {% endif %}

  {% assign products = products | slice: 0, section.settings.products_limit %}
{% endif %}

<div class="featured-products-section" data-section-id="{{ section.id }}">
  <h2>{{ section.settings.heading }}</h2>

  <select class="featured-products-sort">
    <option
      value="best-selling"
      {% if sort_option == 'best-selling' %}
        selected
      {% endif %}
    >
      Best Selling
    </option>
    <option
      value="price-ascending"
      {% if sort_option == 'price-ascending' %}
        selected
      {% endif %}
    >
      Price: Low to High
    </option>
    <option
      value="price-descending"
      {% if sort_option == 'price-descending' %}
        selected
      {% endif %}
    >
      Price: High to Low
    </option>
    <option
      value="title-ascending"
      {% if sort_option == 'title-ascending' %}
        selected
      {% endif %}
    >
      Title: A–Z
    </option>
    <option
      value="title-ascending"
      {% if sort_option == 'title-descending' %}
        selected
      {% endif %}
    >
      Title: Z–A
    </option>
  </select>

  <div class="featured-products-list">
    {% for product in products %}
      <div class="product-item" data-product-id="{{ product.id }}">
        <a href="{{ product.url }}">
          <img
            src="{{ product.featured_image | img_url: 'medium' }}"
            alt="{{ product.title }}"
            width="300"
            height="300"
          >
          <h3>{{ product.title }}</h3>
        </a>

        {% if section.settings.show_price %}
          <p class="product-price">{{ product.price | money_without_currency | prepend: '$' }}</p>
        {% endif %}

        {% if section.settings.show_rating %}
          <p class="product-rating">{{ products.first_available_variant.option3 }}</p>
        {% endif %}

        {% if section.settings.show_add_to_cart %}
          <button class="add-to-cart-btn" data-product-id="{{ product.id }}">Add to Cart</button>
        {% endif %}
      </div>
    {% endfor %}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    console.log({{products[1].first_available_variant.option3}});

    const sectionEl = document.querySelector('.featured-products-section[data-section-id="{{ section.id }}"]');
    const sortSelect = sectionEl.querySelector('.featured-products-sort');

    sortSelect.addEventListener('change', function () {
      const selectedSort = this.value;

      fetch(`${window.location.pathname}?section_id={{ section.id }}&sort_by=${selectedSort}`)
        .then((response) => response.text())
        .then((html) => {
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          const newSection = doc.querySelector('.featured-products-section[data-section-id="{{ section.id }}"]');
          sectionEl.innerHTML = newSection.innerHTML;
          attachAddToCartEvents();
        });
    });

    function renderStars(container, rating) {
      const maxStars = 5;
      container.innerHTML = '';
      for (let i = 1; i <= maxStars; i++) {
        const star = document.createElement('span');
        if (rating >= i) star.className = 'star full';
        else if (rating >= i - 0.5) star.className = 'star half';
        else star.className = 'star empty';
        container.appendChild(star);
      }
    }

    function attachAddToCartEvents() {
      sectionEl.querySelectorAll('.add-to-cart-btn').forEach((btn) => {
        btn.addEventListener('click', function () {
          const productId = this.dataset.productId;
          fetch('/cart/add.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ id: productId, quantity: 1 }),
          })
            .then((response) => response.json())
            .then((data) => {
              console.log('Added to cart:', data);
              window.dispatchEvent(new CustomEvent('cart:updated'));
            });
        });
      });
    }

    attachAddToCartEvents();
  });
</script>

<style>
  .featured-products-section {
    margin: 0 auto;
    padding: 40px;
  }

  .featured-products-section h2 {
    text-align: center;
  }

  .featured-products-sort {
    margin-bottom: 40px;
  }

  .featured-products-list {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin: 0 auto;
  }

  a {
    text-decoration: none;
    color: inherit;
  }

  .product-item a {
    cursor: pointer;
  }

  .product-rating {
    margin-top: 16px;
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .product-rating .star {
    display: inline-block;
    margin-right: 5px;
    width: 17px;
    height: 16px;
    background-position: center;
    background-size: contain;
    background-repeat: no-repeat;
  }

  .product-rating .star.full {
    background-image: url('../assets/full-star.svg');
  }

  .product-rating .star.half {
    background-image: url('../assets/half-star.svg');
  }

  .product-rating .star.empty {
    background-image: url('../assets/empty-star.svg');
  }
</style>
